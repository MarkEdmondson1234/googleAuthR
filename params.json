{
  "name": "googleAuthR - Easy Google APIs within R",
  "tagline": "Google API Client Library for R. Build libraries for any Google API with OAuth2 for both local and Shiny app use.",
  "body": "# googleAuthR - Google API Client Library for R\r\n\r\n[![CRAN](http://www.r-pkg.org/badges/version/googleAuthR)](http://cran.r-project.org/package=googleAuthR)\r\n[![Travis-CI Build Status](https://travis-ci.org/MarkEdmondson1234/googleAuthR.svg?branch=master)](https://travis-ci.org/MarkEdmondson1234/googleAuthR)\r\n[![Coverage Status](https://img.shields.io/codecov/c/github/MarkEdmondson1234/googleAuthR/master.svg)](https://codecov.io/github/MarkEdmondson1234/googleAuthR?branch=master)\r\n\r\nAuto-build libraries for Google APIs with OAuth2 for both local and Shiny app use.\r\nThis guide is also available at the [googleAuthR website](http://code.markedmondson.me/googleAuthR/)\r\n\r\n# Table of Contents\r\n\r\n* [Example libraries](https://github.com/MarkEdmondson1234/googleAuthR#r-google-api-libraries-using-googleauthr)\r\n* [Thanks](https://github.com/MarkEdmondson1234/googleAuthR#thanks-to)\r\n* [Installation](https://github.com/MarkEdmondson1234/googleAuthR#install)\r\n* [Overview](https://github.com/MarkEdmondson1234/googleAuthR#overview)\r\n* [Google API Console Setup](https://github.com/MarkEdmondson1234/googleAuthR#google-api-setup)\r\n* [Building your own Google API functions](https://github.com/MarkEdmondson1234/googleAuthR#generating-your-function)\r\n* [Batching API Calls](https://github.com/MarkEdmondson1234/googleAuthR#batching-api-requests)\r\n* [Service Account Authentication with JSON](https://github.com/MarkEdmondson1234/googleAuthR#authentication-with-a-json-file-via-service-accounts)\r\n* [Authentication with Shiny](https://github.com/MarkEdmondson1234/googleAuthR#authentication-with-shiny)\r\n* [Complete Example making a goo.gl R library](https://github.com/MarkEdmondson1234/googleAuthR#example-with-googl)\r\n\r\n## R Google API libraries using googleAuthR\r\n\r\nHere is a list of [available Google APIs](https://developers.google.com/apis-explorer/#p/) to make with this library.\r\nThe below libraries are all cross-compatible as they use `googleAuthR` for authentication backend e.g. can use just one OAuth2 login flow and can be used in multi-user Shiny apps. \r\n* [searchConsoleR](http://code.markedmondson.me/searchConsoleR/) - Search Console API\r\n* [bigQueryR](http://code.markedmondson.me/bigQueryR/) - BigQuery API. Part of the cloudyr project.\r\n* [googleAnalyticsR](http://code.markedmondson.me/googleAnalyticsR/) - Google Analytics API\r\n* [gtmR](https://github.com/MarkEdmondson1234/gtmR) - Google Tag Manager API (in progress)\r\n* [googleID](https://github.com/MarkEdmondson1234/googleID) - Simple user info from G+ API for Shiny app authentication flows.\r\n* [googleCloudStorageR](http://code.markedmondson.me/googleCloudStorageR/) - Google Cloud Storage API\r\n* [RoogleVision](https://github.com/cloudyr/RoogleVision) - R Package for Image Recogntion, Object Detection, and OCR using the Google's Cloud Vision API\r\n\r\nFeel free to add your own via email or a pull request if you have used googleAuthR to build something cool. \r\n\r\n`googleAuthR` now has an R package generator which makes R package skeletons you can use to build your own Google API R package upon.  Browse through the 154 options at this [Github repository](https://github.com/MarkEdmondson1234/autoGoogleAPI).\r\n\r\n## Example Shiny app\r\n\r\nAn example shiny app with Google authentication is [deployed to shinyapps.io here](https://mark.shinyapps.io/googleAuthRexample/).   It uses the example app that is available in `system.file(\"shiny\", package=\"googleAuthR\")`\r\n## Thanks to:\r\n* Jenny Bryan and her work on the [googlesheets](https://github.com/jennybc/googlesheets) package that this work derives from.\r\n* Hadley Wickham for [httr's OAuth2](https://github.com/hadley/httr) excellence\r\n* RStudio team for [Shiny](http://shiny.rstudio.com/)\r\n* [Johann de Boer](https://github.com/jdeboer) for some code contributions.\r\n\r\n## Install\r\n\r\nGoogleAuthR version 0.3.0 is now available on CRAN\r\n```r\r\ninstall.packages(\"googleAuthR\")\r\n```\r\nCheck out [News](NEWS.md) to see the features of the development version.\r\nIf you want to use the development version on Github, install via:\r\n```r\r\n## load the library or download it if necessary\r\nif(!require(googleAuthR)){\r\n  if(!require(devtools)){\r\n    install.packages(\"devtools\")\r\n  } else {\r\n    devtools::install_github(\"MarkEdmondson1234/googleAuthR\")\r\n  }\r\n}\r\nlibrary(googleAuthR)\r\n```\r\n\r\n## Overview\r\n\r\nThis guide is available at: `vignette(\"googleAuthR\")`\r\nThis library allows you to authenticate easily via local use in an OAuth2 flow; within a Shiny app; or via service accounts. \r\nThe main two functions are `gar_auth()` and `gar_api_generator()`.\r\n### `gar_auth`\r\nThis takes care of getting the authentication token, storing it and refreshing. \r\nUse it before any call to a Google library.\r\n### `gar_api_generator`\r\nThis creates functions for you to use to interact with Google APIs.\r\nUse it within your own function definitions, to query the Google API you want.\r\n## Google API Setup\r\n`googleAuthR` has a default project setup with APIs activated for several APIs, but it is recommended you use your own Client IDs as the login screen will be big and scary for users with so many APIs to approve.  \r\nIt is preferred to configure your functions to only use the scopes they need.  Scopes you need will be specified in the Google API documentation. \r\nSet scopes via the option `googleAuthR.scopes.selected`.\r\nThe below example sets scopes for Search Console, Google Analytics and Tag Manager:\r\n```r\r\noptions(\"googleAuthR.scopes.selected\" = c(\"https://www.googleapis.com/auth/webmasters\",\r\n                                          \"https://www.googleapis.com/auth/analytics\",\r\n                                          \"https://www.googleapis.com/auth/tagmanager.readonly\"))\r\n```\r\n### Set up steps\r\n\r\n1. Set up your project in the Google API Console to use the Google API you want.\r\n\r\n#### For local use\r\n\r\n2. Click 'Create a new Client ID', and choose \"Installed Application\".\r\n3. Note your Client ID and secret.\r\n4. Modify these options after `googleAuthR` has been loaded:\r\n  + `options(\"googleAuthR.client_id\" = \"YOUR_CLIENT_ID\")`\r\n  + `options(\"googleAuthR.client_secret\" = \"YOUR_CLIENT_SECRET\")`\r\n  \r\n#### For Shiny use\r\n\r\n2. Click 'Create a new Client ID', and choose \"Web Application\".\r\n3. Note your Client ID and secret.\r\n4. Add the URL of where your Shiny app will run, with no port number. e.g. https://mark.shinyapps.io/searchConsoleRDemo/\r\n5. And/Or also put in localhost or 127.0.0.1 with a port number for local testing. Remember the port number you use as you will need it later to launch the app e.g. `http://127.0.0.1:1221`\r\n6. In your Shiny script modify these options:\r\n  + `options(\"googleAuthR.webapp.client_id\" = \"YOUR_CLIENT_ID\")`\r\n  + `options(\"googleAuthR.webapp.client_secret\" = \"YOUR_CLIENT_SECRET\")`\r\n7. Run the app locally specifying the port number you used e.g. `shiny::runApp(port=1221)`\r\n8. Or deploy to your Shiny Server that deploys to web port (80 or 443).\r\n\r\n#### Activate API\r\n\r\n1. Click on \"APIs\"\r\n2. Select and activate the API you want to use.\r\n3. Go to the documentation and find the API scope URL\r\n4. Set option in your R script for the scope e.g. \r\n```r\r\noptions(\"googleAuthR.scopes.selected\" = \r\n      c(\"https://www.googleapis.com/auth/urlshortener\"))\r\n```\r\n\r\n## Building your own functions\r\n\r\nIf the above is successful, then you should go through the Google login flow in your browser when you run this command:\r\n```r\r\ngoogleAuthR::gar_auth()\r\n```\r\nIf you ever need to authenticate with a new user, use:\r\n```r\r\ngoogleAuthR::gar_auth(new_user=TRUE)\r\n```\r\nAuthentication token is cached in a hidden file called `.httr-oauth` in the working directory.\r\n\r\n## Authentication with no browser\r\n\r\nIf for some reason you need authentication without access to a browser (for example when using Shiny Server), then you can authenticate locally and upload the `.httr-oauth` file to the folder of your script.\r\n\r\n## Authentication with Shiny\r\n\r\nIf you want to create a Shiny app just using your data, upload the app with your own `.httr-oauth`.\r\nIf you want to make a multi-user Shiny app, where users login to their own Google account and the app works with their data, googleAuthR provides these functions to help make the Google login process as easy as possible.\r\nAs of 0.3.0 googleAuthR uses [Shiny Modules](http://shiny.rstudio.com/articles/modules.html).  This means less code and the ability to have multiple login buttons on the same app.\r\n* `googleAuth` - creates the authentication token and login button styling\r\n* `googleAuthUI` - creates the server side login button for users to authenticate with.\r\n* `with_shiny()` - wraps your API functions so they can be passed the user's authentication token.\r\n#### Shiny authentication example\r\nThis is the example [deployed to shinyapps.io here](https://mark.shinyapps.io/googleAuthRexample/)\r\n```r\r\n## in global.R\r\nlibrary(googleAuthR)\r\nlibrary(shiny)\r\noptions(googleAuthR.scopes.selected = \"https://www.googleapis.com/auth/urlshortener\")\r\noptions(googleAnalyticsR.webapp.client_id = \"YOUR_PROJECT_KEY\")\r\noptions(googleAnalyticsR.webapp.client_secret = \"YOUR_CLIENT_SECRET\")\r\nshorten_url <- function(url){\r\n  \r\n  body = list(\r\n    longUrl = url\r\n  )\r\n  \r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                         \"POST\",\r\n                         data_parse_function = function(x) x$id)\r\n  \r\n  f(the_body = body)\r\n  \r\n}\r\n## server.R\r\nsource(\"global.R\")\r\nserver <- function(input, output, session){\r\n  \r\n  ## Create access token and render login button\r\n  access_token <- callModule(googleAuth, \"loginButton\")\r\n  \r\n  short_url_output <- eventReactive(input$submit, {\r\n    ## wrap existing function with_shiny\r\n    ## pass the reactive token in shiny_access_token\r\n    ## pass other named arguments\r\n    with_shiny(f = shorten_url, \r\n               shiny_access_token = access_token(),\r\n               url=input$url)\r\n    \r\n  })\r\n  \r\n  output$short_url <- renderText({\r\n    \r\n    short_url_output()\r\n    \r\n  })\r\n}\r\n## ui.R\r\nui <- fluidPage(\r\n  googleAuthUI(\"loginButton\"),\r\n  textInput(\"url\", \"Enter URL\"),\r\n  actionButton(\"submit\", \"Shorten URL\"),\r\n  textOutput(\"short_url\")\r\n)\r\n### If the above global.R, server.R and ui.R files are in folder \"test\" like so:\r\n## /home\r\n##    |->/test/\r\n##            /global.R\r\n##            /ui.R\r\n##            /server.R\r\n##\r\n## Port 1221 has been set in your Google Project options as the port to listen to\r\n## as explained in authentication setup section\r\n## run below in /home directory\r\nshiny::runApp(\"./test/\", launch.browser=T, port=1221)\r\n```\r\n \r\n## Authentication with a JSON file via Service Accounts\r\n\r\nYou can also authenticate single users via a server side JSON file rather than going through the online OAuth2 flow.  The end user could supply this JSON file, or you can upload your own JSON file to your applications. \r\nThis involves downloading a secret JSON key with the authentication details.  More details are available from Google here: Using OAuth2.0 for Server to Server Applications[https://developers.google.com/identity/protocols/OAuth2ServiceAccount]\r\nTo use, go to your Project in the Google Developement Console and select JSON Key type.  Save the JSON file to your computer and supply the file location to the function\r\n`gar_auth_service()`\r\n  \r\nNavigate to the JSON file from the Google Developer Console via: \r\nCredentials > New credentials > Service account Key > Select service account > Key type = JSON\r\n      \r\nAn example using a service account JSON file for authentication is shown below:\r\n```r\r\nlibrary(googleAuthR)\r\nservice_token <- gar_auth_service(json_file=\"~/location/of/the/json/secret.json\")\r\nanalytics_url <- function(shortUrl, \r\n                          timespan = c(\"allTime\", \"month\", \"week\",\"day\",\"twoHours\")){\r\n  \r\n  timespan <- match.arg(timespan)\r\n  \r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                         \"GET\",\r\n                         pars_args = list(shortUrl = \"shortUrl\",\r\n                                          projection = \"FULL\"),\r\n                         data_parse_function = function(x) { \r\n                           a <- x$analytics \r\n                           return(a[timespan][[1]])\r\n                         })\r\n  \r\n  f(pars_arguments = list(shortUrl = shortUrl))\r\n}\r\nanalytics_url(\"https://goo.gl/2FcFVQbk\")\r\n```\r\n\r\n## Authentication via RStudio Addin\r\n\r\nFrom version `0.3.0` a RStudio Addin is available via the RStudio Addin menu once you load the package, or via `googleAuthR:::gar_gadget()`\r\nIt lets you set the scopes and then saves you some typing by calling the Google authentication flow for you.\r\n![googleAuthRGadget](https://storage.googleapis.com/mark-edmondson-public-files/myObject)\r\n\r\n## Authentication in RMarkdown via JavaScript\r\n\r\nFrom version `0.4.0` there are two functions that can be called from within RMarkdown for authentication.  They use JavaScript, rather than R/Shiny to authenticate, as an RMarkdown document can not read the URL tokens.\r\n\r\nA demo and example are available here: `https://mark.shinyapps.io/googleAuthRMarkdown/`\r\n\r\n### Setup\r\n\r\nThe RMarkdown document YAML needs runtime shiny and to be a HTML document:\r\n\r\n```\r\noutput: html_document\r\nruntime: shiny\r\n```\r\n\r\nLocally, you have to run the RMarkdown document on the specified port configured in Google console (`1221` for the default shared project of `googleAuthR`), configured via `options(shiny.port = 1221)`\r\n\r\nThis means you shouldnâ€™t launch the RMarkdown via the Run button in RStudio as that starts a new R session without your set options.\r\n\r\nInstead set the options and run via `rmarkdown::run(\"myfile.Rmd\")`\r\n\r\n```r\r\noptions(shiny.port = 1221)\r\noptions(googleAuthR.scopes.selected = \"https://www.googleapis.com/auth/plus.me\")\r\nrmarkdown::run(\"googleAuthRMarkdown.Rmd\")\r\n```\r\n\r\nWhen publishing, you also need to add the domain to the Javascript origins in the Google API console. Use `127.0.0.1:XXX` where XXX is your chosen Shiny port for local testing.\r\n\r\n### Example of RMarkdown authentication\r\n\r\nBelow creates a button that when clicked makes a popup for Google authentication:\r\n\r\n```r\r\nlibrary(googleAuthR)\r\n\r\ngar_auth_jsUI(\"auth_demo\", login_text = \"Click Me\")\r\n\r\n```\r\nThe authentication token is available via the server side module command:\r\n\r\n```\r\nauth <- callModule(gar_auth_js, \"auth_demo\")\r\n```\r\nPass the auth token to API functions. Below example using googleID to return G+ user info.\r\n```\r\n# devtools::install_github(\"MarkEdmondson1234/googleID\")\r\nlibrary(googleID)\r\n\r\nuser_info <- reactive({\r\n  \r\n  req(auth())\r\n  \r\n  with_shiny(get_user_info,\r\n             shiny_access_token = auth())\r\n  \r\n})\r\n```\r\nYou can now output the user data taken from the G+ API:\r\n\r\n```\r\n## creates an output\r\nrenderUI({\r\n  \r\n  req(user_info())\r\n  \r\n  h1(\"Hello \", user_info()$displayName)\r\n  \r\n})\r\n```\r\n\r\n## Auto-authentication\r\n\r\nFrom version `0.4.0` auto-authentication can be performed upon a package load.\r\n\r\nThis requires the setup of environment variables either in your `.Renviron` file or via `Sys.setenv()` to point to a previously created authentication file.  This file can be either a `.httr-oauth` file created via `gar_auth()` or a Google service account JSON downloaded from the Google API console.\r\n\r\n\r\nThis file will then be used for authentication via `gar_auth_auto`.  You can call this function yourself in scripts or R sessions, but its main intention is to be called in the `.onAttach` function via `gar_attach_auth_auto`, so that you will authenticate right after you load the library via `library(yourlibrary)`\r\n\r\nAn example from `googleCloudStorageR` is shown below:\r\n\r\n```r\r\n.onAttach <- function(libname, pkgname){\r\n\r\n  googleAuthR::gar_attach_auto_auth(\"https://www.googleapis.com/auth/devstorage.full_control\",\r\n                                    environment_var = \"GCS_AUTH_FILE\")\r\n}\r\n\r\n```\r\n\r\n..which calls an environment variable set in `~/.Renvion`:\r\n\r\n```\r\nGCS_AUTH_FILE=\"/Users/mark/auth/my_auth_file.json\"\r\n```\r\n\r\n\r\n## Revoking Authentication\r\nFor local use, delete the `.httr-oauth` file.\r\nFor service level accounts delete the JSON file.\r\nFor a Shiny app, a cookie is left by Google that will mean a faster login next time a user uses the app with no Authorization screen that they get the first time through.  To force this every time, activate the parameter `revoke=TRUE` within the `googleAuth` function.\r\n\r\n# Build a Google API library \r\n\r\n## Generating your function\r\n\r\nCreating your own API should then be a matter of consulting the Google API documentation, and filling in the required details.\r\n`gar_api_generator` has these components:\r\n* `baseURI` - all APIs have a base for every API call\r\n* `http_header` - what type of request, most common are GET and POST\r\n* `path_args` - some APIs need you to alter the URL folder structure when calling, e.g. `/account/{accountId}/` where `accountId` is variable.\r\n* `pars_args` - other APIS require you to send URL parameters e.g. `?account={accountId}` where `accountId` is variable.\r\n* `data_parse_function` - [optional] If the API call returns data, it will be available in `$content`. You can create a parsing function that transforms it in to something you can work with (for instance, a dataframe)\r\nExample below for generating a function:\r\n```r\r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                         \"POST\",\r\n                         data_parse_function = function(x) x$id)\r\n```\r\n## Using your generated function\r\nThe function generated uses `path_args` and `pars_args` to create a template, but when the function is called you will want to pass dynamic data to them.  This is done via the `path_arguments` and `pars_arguments` parameters.\r\n`path_args` and `pars_args` and `path_arguments` and `pars_arguments` all accept named lists.\r\nIf a name in `path_args` is present in `path_arguments`, then it is substituted in.  This way you can pass dynamic parameters to the constructed function.  Likewise for `pars_args` and `pars_arguments`.\r\n```r\r\n## Create a function that requires a path argument /accounts/{accountId}\r\n  f <- gar_api_generator(\"https://www.googleapis.com/example\",\r\n                         \"POST\",\r\n                         path_args = list(accounts = \"defaultAccountId\")\r\n                         data_parse_function = function(x) x$id)\r\n                             \r\n## When using f(), pass the path_arguments function to it \r\n## with the same name to modify \"defaultAccountId\":\r\n  result <- f(path_arguments = list(accounts = \"myAccountId\"))\r\n```\r\n### Body data\r\n\r\nA lot of Google APIs look for you to send data in the Body of the request.  This is done after you construct the function.\r\n `googleAuthR` uses `httr`'s JSON parsing via `jsonlite` to construct JSON from R lists.\r\n \r\n Construct your list, then use `jsonlite::toJSON` to check if its in the correct format as specified by the Google documentation.  This is often the hardest part using the API.\r\n \r\n### Parsing data\r\n\r\nNot all API calls return data, but if they do:\r\nIf you have no `data_parse_function` then the function returns the whole request object.  The content is available in `$content`.  You can then parse this yourself, or pass a function in to do it for you.\r\nIf you parse in a function into `data_parse_function`, it works on the response's `$content`.\r\nExample below of the differences between having a data parsing function and not:\r\n```r\r\n  ## the body object that will be passed in\r\n  body = list(\r\n    longUrl = \"http://www.google.com\"\r\n  )\r\n  \r\n  ## no data parsing function\r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                         \"POST\")\r\n                         \r\n  no_parse <- f(the_body = body)\r\n  \r\n  ## parsed data, only taking request$content$id\r\n  f2 <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                          \"POST\",\r\n                          data_parse_function = function(x) x$id)\r\n  \r\n  parsed <- f2(the_body = body)\r\n  \r\n  ## str(no_parse) has full details of API response.\r\n  ## just looking at no_parse$content as this is what API returns\r\n  > str(no_parse$content)\r\n  List of 3\r\n   $ kind   : chr \"urlshortener#url\"\r\n   $ id     : chr \"http://goo.gl/ZwT9pG\"\r\n   $ longUrl: chr \"http://www.google.com/\"\r\n \r\n  ## compare to the above - equivalent to no_parse$content$id \r\n  > str(parsed)\r\n   chr \"http://goo.gl/mCYw2i\"\r\n                             \r\n```\r\nThe response is turned from JSON to a dataframe if possible, via `jsonlite::fromJSON`\r\n\r\n### Skip parsing\r\n\r\nIn some cases you may want to skip all parsing of API content, perhaps if it is not JSON or some other reason.\r\nFor these cases, you can use the option `option(\"googleAuthR.rawResponse\" = TRUE)` to skip all tests and return the raw response.\r\nHere is an example of this from the googleCloudStorageR library:\r\n```r\r\ngcs_get_object <- function(bucket, \r\n                           object_name){\r\n  ## skip JSON parsing on output as we epxect a CSV\r\n  options(googleAuthR.rawResponse = TRUE)\r\n  \r\n  ## do the request\r\n  ob <- googleAuthR::gar_api_generator(\"https://www.googleapis.com/storage/v1/\",\r\n                                       path_args = list(b = bucket,\r\n                                                        o = object_name),\r\n                                       pars_args = list(alt = \"media\"))\r\n  req <- ob()\r\n  \r\n  ## set it back to FALSE for other API calls.\r\n  options(googleAuthR.rawResponse = FALSE)\r\n  req\r\n}\r\n```\r\n\r\n### Batching API requests\r\n\r\nIf you are doing many API calls, you can speed this up a lot by using the batch option.\r\nThis takes the API functions you have created and wraps them in the `gar_batch` function to request them all in one POST call.  You then recieve the responses in a list.\r\nNote that this does not count as one call for API limits purposes, it just speeds up the processing.\r\nThe example below queries from two different APIs and returns them in a list: It lists websites in your Google Search Console, and shows your goo.gl link history.\r\n\r\n```r\r\n## from search console API\r\nlist_websites <- function() {\r\n  \r\n  l <- gar_api_generator(\"https://www.googleapis.com/webmasters/v3/sites\",\r\n                                      \"GET\",\r\n                                      data_parse_function = function(x) x$siteEntry)\r\n  l()\r\n}\r\n## from goo.gl API\r\nuser_history <- function(){\r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url/history\",\r\n                         \"GET\",\r\n                         data_parse_function = function(x) x$items)\r\n  \r\n  f()\r\n}\r\ngoogleAuthR::gar_auth(new_user=T)\r\nggg <- gar_batch(list(list_websites(), user_history()))\r\n```\r\n\r\n#### Walking through batch requests\r\n\r\nA common batch task is to walk through the same API call, modifying only one parameter.  An example includes walking through Google Analytics API calls by date to avoid sampling.\r\nA function to enable this is implemented at `gar_batch_walk`, with an example below:\r\n```r\r\nwalkData <- function(ga, ga_pars, start, end){\r\n  dates <- as.character(\r\n    seq(as.Date(start, format=\"%Y-%m-%d\"),\r\n        as.Date(end, format=\"%Y-%m-%d\"),\r\n        by=1))\r\n  ga_pars$samplingLevel <- \"HIGHER_PRECISION\"\r\n  anyBatchSampled <- FALSE\r\n  samplePercent   <- 0\r\n  \r\n  \r\n  ## this is applied to each batch to keep tally of meta data\r\n  bf <- function(batch_data){\r\n    lapply(batch_data, function(the_data) {\r\n      if(attr(the_data, 'containsSampledData')) anyBatchSampled <<- TRUE\r\n      samplePercent <<- samplePercent + attr(the_data, \"samplePercent\")\r\n    })\r\n    batch_data\r\n  }\r\n  ## the walk through batch function. \r\n  ## In this case both start-date and end-date are set to the date iteration\r\n  ## if the output is parsed as a dataframe, it also includes a rbind function\r\n  ## otherwise, it will return a list of lists\r\n  walked_data <- googleAuthR::gar_batch_walk(ga,\r\n                                             dates,\r\n                                             gar_pars = ga_pars,\r\n                                             pars_walk = c(\"start-date\", \"end-date\"),\r\n                                             batch_function = bf,\r\n                                             data_frame_output = TRUE)\r\n  message(\"Walked through all dates. Total Results: [\", NROW(walked_data), \"]\")\r\n  attr(walked_data, \"dateRange\") <- list(startDate = start, endDate = end)\r\n  attr(walked_data, \"totalResults\") <- NROW(walked_data)\r\n  attr(walked_data, \"samplingLevel\") <- \"HIGHER_PRECISION, WALKED\"\r\n  attr(walked_data, \"containsSampledData\") <- anyBatchSampled\r\n  attr(walked_data, \"samplePercent\") <- samplePercent / length(dates)\r\n  walked_data\r\n}\r\n```\r\n\r\n## Auto-build libraries\r\n\r\nNew in `0.4` is helper functions that use Google's [API Discovery service](https://developers.google.com/discovery/).\r\n\r\nThis is a meta-API which holds all the necessary details to build a supported Google API, which is all modern Google APIs.  At the time of writing this is 152 libraries.\r\n\r\nThese libraries aren't intended to be submitted to CRAN or used straight away, but should take away a lot of documentation and function building work so you can concentrate on tests, examples and helper functions for your users.\r\n\r\nGet a list of the current APIs via `gar_discovery_apis_list()`\r\n\r\n```r\r\nall_apis <- gar_discovery_apis_list()\r\n```\r\n\r\nTo get details of a particular API, use its name and version in the `gar_discovery_api()` function:\r\n\r\n```r\r\na_api <- gar_discovery_api(\"urlshortener\", \"v1\")\r\n```\r\n\r\nYou can then pass this list to `gar_create_package()` along with a folder path to create all the files necessary for an R library.  There are arguments to set it up with RStudio project files, do a `CRAN CMD check` and upload it to Github.\r\n\r\n```r\r\nvision_api <- gar_discovery_api(\"vision\", \"v1\")\r\ngar_create_package(vision_api,\r\n                   \"/Users/mark/dev/R/autoGoogleAPI/\",\r\n                   rstudio = FALSE,\r\n                   github = FALSE)\r\n\r\n```\r\n\r\n### Auto-build all libraries\r\n\r\nA loop to build all the Google libraries is shown below, the results of which is available in this [Github repo](https://github.com/MarkEdmondson1234/autoGoogleAPI).\r\n\r\n```r\r\nlibrary(googleAuthR)\r\n\r\napi_df <- gar_discovery_apis_list()\r\n\r\napi_json_list <- mapply(gar_discovery_api, api_df$name, api_df$version)\r\n\r\n## WARNING: this takes a couple of hours\r\ncheck_results <- lapply(api_json_list, \r\n                        gar_create_package, \r\n                        directory = \"/Users/mark/dev/R/autoGoogleAPI\",\r\n                        github = FALSE)\r\n\r\n```\r\n\r\n## Example with goo.gl\r\n\r\nBelow is an example building a link shortner R package using `googleAuthR`.\r\nIt was done referring to the [documentation for Google URL shortener](https://developers.google.com/url-shortener/v1/getting_started).\r\nNote the help docs specifies the steps outlined above. These are in general the steps for every Google API.\r\n\r\n1. Creating a project\r\n2. Activate API\r\n3. Provide scope\r\n4. Specify the base URL (in this case `https://www.googleapis.com/urlshortener/v1/url`)\r\n5. Specify the httr request type e.g. `POST`\r\n6. Constructing a body request\r\n7. Giving the response format\r\n\r\n### Example goo.gl R library\r\n```r\r\nlibrary(googleAuthR)\r\n## change the native googleAuthR scopes to the one needed.\r\noptions(\"googleAuthR.scopes.selected\" = \r\n        c(\"https://www.googleapis.com/auth/urlshortener\"))\r\n#' Shortens a url using goo.gl\r\n#'\r\n#' @param url URl to shorten with goo.gl\r\n#' \r\n#' @return a string of the short URL\r\nshorten_url <- function(url){\r\n  \r\n  body = list(\r\n    longUrl = url\r\n  )\r\n  \r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                         \"POST\",\r\n                         data_parse_function = function(x) x$id)\r\n  \r\n  f(the_body = body)\r\n  \r\n}\r\n#' Expands a url that has used goo.gl\r\n#'\r\n#' @param shortUrl Url that was shortened with goo.gl\r\n#' \r\n#' @return a string of the expanded URL\r\nexpand_url <- function(shortUrl){\r\n  \r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                         \"GET\",\r\n                         pars_args = list(shortUrl = \"shortUrl\"),\r\n                         data_parse_function = function(x) x)\r\n                         \r\n  f(pars_arguments = list(shortUrl = shortUrl))\r\n  \r\n}\r\n#' Get analyitcs of a url that has used goo.gl\r\n#'\r\n#' @param shortUrl Url that was shortened with goo.gl\r\n#' @param timespan The time period for the analytics data\r\n#' \r\n#' @return a dataframe of the goo.gl Url analytics\r\nanalytics_url <- function(shortUrl, \r\n                          timespan = c(\"allTime\", \"month\", \"week\",\"day\",\"twoHours\")){\r\n  \r\n  timespan <- match.arg(timespan)\r\n    \r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url\",\r\n                         \"GET\",\r\n                         pars_args = list(shortUrl = \"shortUrl\",\r\n                                          projection = \"FULL\"),\r\n                         data_parse_function = function(x) { \r\n                                    a <- x$analytics \r\n                                    return(a[timespan][[1]])\r\n                                    })\r\n  \r\n  f(pars_arguments = list(shortUrl = shortUrl))\r\n}\r\n#' Get the history of the authenticated user\r\n#' \r\n#' @return a dataframe of the goo.gl user's history\r\nuser_history <- function(){\r\n  f <- gar_api_generator(\"https://www.googleapis.com/urlshortener/v1/url/history\",\r\n                         \"GET\",\r\n                         data_parse_function = function(x) x$items)\r\n  \r\n  f()\r\n}\r\n```\r\nTo use the above functions:\r\n```r\r\nlibrary(googleAuthR)\r\n# go through authentication flow\r\ngar_auth()\r\ns <- shorten_url(\"http://markedmondson.me\")\r\ns\r\nexpand_url(s)\r\nanalytics_url(s, timespan = \"month\")\r\nuser_history()\r\n```",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}